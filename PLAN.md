# 📄 VRM → Second Life glTF 変換ツール仕様書（1体専用）

## 🎯 目的

VRoidで作成したVRMファイルを、Second Life で使用可能なリグ付きglTF 2.0へ変換する。

## 🛑 制約

- 1体専用（汎用性不要）
- 揺れボーン（髪・尻尾・耳・服物理）無視
- 胸揺れ・尻揺れはSecond Lifeのシェイプ仕様依存のため非対応
- 表情（BlendShape）無視
- アニメーション無視
- Bento拡張ボーンは、目、まぶた、口、指のみ対応
- シェイプ追従非対応
- Fitted Mesh非対応
- Humanoid主要ボーンのみ対応
- **現時点ではVRoid Studio標準出力のVRMのみ対応**

## 🗺️ ロードマップ

### v1.0（次のバージョン）：尾・耳・羽の動作実装

揺れボーン（髪・尻尾・耳・服物理）を検出・変換して、動作するボーンとして対応。
※ 胸揺れ・尻揺れはSecond Lifeのシェイプ仕様側で扱う前提のため、本ツールでは対応しない。

### v1.1（その次のバージョン）：ヘッド抽出モード

アバター全体ではなく、ヘッド部分のみを抽出して出力するモードを実装。

- ヘッドメッシュのみ抽出
- ヘッド関連ボーン（head, mEyeLeft, mEyeRight, mFaceJaw等）のみ保持
- 独立した.gdbファイルとして出力

## 🧩 入出力仕様

**入力：** VRM 1.0（.vrm ファイル）

**出力：** glTF 2.0形式（.gdbファイル、SLアップロード可能。daeは非対応）

## 🛠 技術スタック（Rust）

**使用クレート：**

- gltf
- serde
- serde_json
- nalgebra
- anyhow
- oxipng（PNG再圧縮用）
- image（テクスチャリサイズ用）

---

## 🔧 変換処理フロー

### 1️⃣ VRM読み込み

**要件**

- glTFとしてパース
- VRM拡張からHumanoidボーンマッピング抽出

**対象ボーン：**

```
hips, spine, chest, neck, head,
leftUpperArm, leftLowerArm, leftHand,
rightUpperArm, rightLowerArm, rightHand,
leftUpperLeg, leftLowerLeg, leftFoot,
rightUpperLeg, rightLowerLeg, rightFoot
```

### 🦴 必要ボーン一覧（Second Life Bento拡張）

#### 主要ボーン（VRM→SL変換）

- Hips → mPelvis
- Spine → mTorso
- Chest → mChest
- Neck → mNeck
- Head → mHead
- 両腕・両脚各部位

#### Bento拡張ボーン

**目：** mEyeLeft, mEyeRight（視線追従）
**口：** mFaceJaw（チャット・音声連動）
**まぶた：** mFaceEyeLidUpperLeft, mFaceEyeLidUpperRight（自動瞬き）
**指（両手フルセット）：**

- 左手例：mHandThumb1Left～Thumb3Left, mHandIndex1Left～Index3Left ...等
- 右手も同様

### 2️⃣ ボーン名マッピング

| VRM           | SL             |
| ------------- | -------------- |
| hips          | mPelvis        |
| spine         | mTorso         |
| chest         | mChest         |
| neck          | mNeck          |
| head          | mHead          |
| leftUpperArm  | mShoulderLeft  |
| leftLowerArm  | mElbowLeft     |
| leftHand      | mWristLeft     |
| rightUpperArm | mShoulderRight |
| rightLowerArm | mElbowRight    |
| rightHand     | mWristRight    |
| leftUpperLeg  | mHipLeft       |
| leftLowerLeg  | mKneeLeft      |
| leftFoot      | mAnkleLeft     |
| rightUpperLeg | mHipRight      |
| rightLowerLeg | mKneeRight     |
| rightFoot     | mAnkleRight    |

**補足：** upperChestは削除（chestへ統合）。不要ボーンは完全削除。

### 3️⃣ 階層再構成

**最終階層例：**

```
mPelvis
├ mTorso
│  ├ mChest
│  │  ├ mShoulderLeft → mElbowLeft → mWristLeft
│  │  └ mShoulderRight → mElbowRight → mWristRight
│  ├ mNeck → mHead
│  └ ...その他Bento拡張ボーン
├ mHipLeft → mKneeLeft → mAnkleLeft
└ mHipRight → mKneeRight → mAnkleRight
```

### 4️⃣ Aポーズ → Tポーズ補正

**問題**

VRoidはAポーズ。SLは厳密なTポーズ。

**対応**

- 上腕ボーンの現在ローカル回転を取得
- 水平（X軸）へ回転補正
- 補正クォータニオンを計算
- ボーン回転を修正
- 同時に頂点を逆方向へ回転補正

**数学処理：**

```rust
corrected_rotation = target_T_pose * inverse(current_pose)
v' = correction_matrix * v
```

### 5️⃣ inverseBindMatrices再生成

1. 各ボーンのワールド行列を計算
2. 逆行列を求める
3. skins.inverseBindMatricesへ書き込み

**計算式：**

```rust
bind_matrix = parent_world * local_transform
inverse_bind = bind_matrix.inverse()
```

### 6️⃣ ウェイト整理

- 削除ボーンに割り当てられているウェイトを親へ再分配
- 未使用ボーンをjointsから削除
- joints配列をSLボーン順に再構築

### 7️⃣ メッシュ整理

- 不要ノード削除
- Morph target削除
- Animation削除
- Extras削除
- VRM拡張削除
- 最終的に純粋なglTF 2.0へ

---

## 📐 数学仕様

**使用型：**

```rust
Matrix4<f32>
Vector3<f32>
UnitQuaternion<f32>
```

**座標系：** glTF準拠（右手座標、Y-up）

---

## 🚨 重要制約

- ボーン名完全一致必須
- 階層完全一致必須
- inverseBindMatricesとノード整合必須
- スケールは1.0固定
- 全TransformをApply済みにする

---

## 💻 アーキテクチャ

テンプレート：[tauri-vuetify-starter](https://github.com/logue/tauri-vuetify-starter)

```
┌─────────────────────────┐
│    Vue + Vuetify UI      │
│  ・VRM読み込み          │
│  ・身長/スケール設定    │
│  ・ボーンマッピング確認 │
│  ・顔アニメ設定         │
│  ・プレビュー（3D）     │
│  ・エクスポート         │
└────────────┬────────────┘
             │ Tauri IPC invoke
┌────────────▼────────────┐
│      Rust Core          │
│  ・VRM解析              │
│  ・ボーン変換           │
│  ・行列再計算           │
│  ・ウェイト処理         │
│  ・バインド再生成       │
└────────────┬────────────┘
             │
         .gdbファイル
```

---

## 🎨 GUI仕様

### 1️⃣ VRM読み込みエリア

**セクション内容**

- 📂 「VRMファイルを選択」ボタン
- VRM基本情報表示
  - モデル名
  - 作者
  - 推定身長
  - ボーン数
  - メッシュ数
- 読み込みステータス表示

### 2️⃣ 身長・スケール設定エリア

SLは身長200cm基準（VRM標準は170cm）のため倍率調整が必須。

**必須パーツ**

- VRM検出身長（自動表示、cm）
- SL目標身長入力フィールド（デフォルト：200cm）
- 自動計算スケール表示
- 手動スケール微調整スライダー
- 「等倍リセット」ボタン

**プレビュー補助**

- 床グリッド表示ON/OFF
- 170cm / 200cm ガイドライン表示トグル

### 3️⃣ ボーンマッピング確認エリア

**最低限必要ボーン**

- Hips, Spine, Chest, Neck, Head
- 両腕・両脚各部
- mEyeLeft / mEyeRight
- mFaceJaw
- 指（全20本）

**GUI要素**

- 自動マッピング結果表示
- 手動修正ドロップダウン
- 未割当ボーン警告表示
- 「必須ボーン不足」エラー表示

### 4️⃣ 顔アニメーション設定エリア

#### 👁 瞬き

- ON/OFF トグル
- 瞬き間隔スライダー
- 閉じ時間スライダー
- 片目ウィンク対応チェック

#### 👄 クチパク

- ON/OFF トグル
- タイピング連動 / チャット連動 モード選択
- 開口角度スライダー
- 開閉スピードスライダー

#### 👀 瞳

- カメラ追従ON/OFF
- ランダム視線ON/OFF
- 可動範囲スライダー（上下角度、左右角度）
- 移動速度スライダー

### 5️⃣ 指ボーン確認エリア

- 自動割当結果表示
- 各指の曲げテストボタン
- 一括ポーズテスト（グー・パー）

### 6️⃣ プレビューエリア（超重要）

**フレームワーク：** three.js想定

**基本機能**

- モデル表示（自動更新）
- 回転ドラッグ操作
- ズーム制御
- ライトON/OFF
- ワイヤーフレーム表示切り替え

**ボーン操作**

- ボーン表示/非表示
- ボーン選択ハイライト
- Tポーズ確認

**アニメーション再生テスト**

- 歩行アニメ再生
- 待機アニメ再生
- 指ポーズ再生
- 顔アニメテスト再生

**アニメーションソース：** Second Life公式ビューアリポジトリから自動ダウンロード  
**形式変換：** Second Life標準形式 → three.js互換形式に自動変換

### 7️⃣ エクスポート設定

**出力形式選択**

- glTF（SL用、推奨）
- バイナリglb

**オプション**

- ボーン圧縮ON/OFF
- 不要ボーン削除確認
- スケール適用方法選択
- **📦 テクスチャ圧縮設定**
  - [ON] テクスチャサイズ自動縮小（推奨）
    - 1024×1024超過時に自動的に1024×1024以下へリサイズ
    - PNG再圧縮（oxipng使用）で容量最適化
      - リサイズ方法選択：バイリニア（デフォルト） / ニアレスト / バイキュービック / Gaussian / Lanczos3
  - [OFF] オリジナルサイズを保持（アップロード費用増加）

### 8️⃣ バリデーションパネル

**チェック項目**

- ✅ 未割当ボーン警告
- ✅ ウェイト異常検出
- ✅ ボーン階層エラー
- ✅ 非対応ノード検出
- ✅ ⚠️ **頂点数制限警告**（Second Life上限：65535頂点）
  - 超過時：「⛔ 頂点数オーバー（現在: xxxxx / 上限: 65535）。アップロードできません」
  - 対策案：メッシュ統合やテクスチャベイク推奨
- ✅ 💰 **テクスチャサイズと費用警告**
  - テクスチャが1024×1024を超過時：「⚠️ テクスチャサイズが大きいため、Second Lifeアップロード費用が増加します」
  - 詳細表示：各テクスチャの解像度一覧
  - 推奨：「📦 テクスチャ圧縮・自動縮小をONに設定してください」
  - 自動縮小時の費用削減目安を表示
- ✅ ポリゴン数警告

### 9️⃣ プロジェクト保存機能

- 設定JSON保存
- 設定読込
- 最後の作業状態自動復元

**仕様：** JSONスキーマを用意

### 📋 最小限構成（MVP）

今すぐ実装すべき順序：

- [x] VRM読込
- [x] 身長スケール設定
- [x] ボーンマッピング確認
- [x] 顔制御設定（簡潔版）
- [x] 指確認
- [x] 3Dプレビュー（three.js、バックエンド生成GLB表示）
- [x] エクスポート（.gdb出力）

### 🧾 実装済み（2026-02-26時点）

- [x] Rustバックエンドの解析/変換コマンド（Tauri IPC・CLI）
- [x] VRM拡張ベースのHumanoidボーン抽出（VRMC_vrm / VRMフォールバック）
- [x] 必須ボーン不足・階層不整合・頂点数・テクスチャ警告のバリデーション表示
- [x] テクスチャ自動縮小ポリシー（1024/2048）と出力後サイズレポート
- [x] プロジェクト設定の保存/読込
- [x] 2カラムUI（左:操作 / 右:プレビュー）とログ表示DOM

### 📌 残件（マイルストーン別）

#### v0.9（コア変換の完成）

- [ ] Aポーズ→Tポーズ補正の本実装（上腕回転補正＋頂点逆補正）
- [ ] inverseBindMatrices再生成の本実装
- [ ] ウェイト再分配・joints最適化の本実装
- [ ] ボーン階層の再構成（SL向け最終階層を明示的に構築）
- [ ] Bento拡張ボーン（目・口・まぶた・指）の実運用レベル対応
- [ ] Blender再読込～SLアップロードの最終検証フロー完了

#### v1.0（次バージョン）

- [ ] 尾・耳・羽の動作対応
- [ ] プレビューの追加操作（グリッド/ライト/ワイヤーフレーム切替）
- [ ] アニメーション自動取得・形式変換・再生テスト機能

#### v1.1（その次のバージョン）

- [ ] ヘッド抽出モード

---

## 🔨 実装詳細仕様

### エラーハンドリング戦略

**VRoid Studio標準出力のVRMのみ対応。それ以外はエラー出力して終了。**

**対応ケース**

✅ VRoid Studioで標準出力されたVRM  
&nbsp;&nbsp;→ 必須ボーンが全て存在、標準的なボーン階層構造

**非対応ケース（エラー出力のみ）**

❌ VRoid Studio以外で作成されたVRM  
❌ 標準Humanoidボーンが欠落  
❌ 非標準的なボーン命名  
❌ カスタムボーン構造

**エラーメッセージ例：**

```
[ERROR] VRoid Studio標準のVRMのみサポートしています
[ERROR] 必須ボーン XXX が見つかりません
[ERROR] 非標準的なボーン階層です
```

### 検証チェックリスト（開発時）

- □ 全ボーンがinverseBindMatricesに含まれる
- □ joints配列が重複なく構成される
- □ ウェイト合計がプリミティブごとに1.0
- □ バウンディングボックス再計算完了

### 出力仕様

- **形式：** .gdbファイル（glTF 2.0準拠、VRM拡張なし）
- **内容：** メッシュ + ボーン + テクスチャ（画像データ込み）
- **対応：** .gdbのみ（.dae等は非対応）

### アニメーション管理戦略

**ライセンス制約**

アニメーションファイルはSecond Life公式ビューアのライセンス上の理由により、パッケージに同梱できません。

**アニメーション取得方法**

1. **ソース：** Second Life公式ビューアリポジトリ
   - 公式ビューアから標準アニメーション（walk, stand, sit等）を取得
   - ダウンロードはアプリ初回実行時、またはアニメーション再生時に自動実行

2. **キャッシング**
   - ダウンロードしたアニメーションはローカルキャッシュに保存
   - 次回実行時はネットワークアクセスなしで即座に利用可能

**形式変換**

Second Lifeのアニメーション形式（.anim等、BVH互換）は、three.jsでは直接再生できません。以下の処理が必要：

- **入力形式：** BVH形式またはSecond Life標準形式
- **変換処理：** glTF 2.0 Animation形式へ変換
- **ツール：** 既存のBVH→glTF変換ライブラリ利用、または自作変換スクリプト
- **出力形式：** glTFアニメーション（Keyframe Track化）

**実装の流れ**

```
1. 公式ビューアリポジトリからアニメーションダウンロード
   ↓
2. キャッシュディレクトリに保存
   ↓
3. BVH→glTFアニメーション変換
   ↓
4. three.jsのMixer/AnimationClipで再生テスト
```

**注意点**

- ネットワークエラー時の自動リトライ機能
- ダウンロード進捗表示
- キャッシュサイズ管理（不要な古いアニメーションの削除機能）

### テクスチャ処理戦略

**自動縮小オプション（デフォルト：ON）**

テクスチャサイズが1024×1024を超える場合、以下の処理を自動実行：

**処理流れ**

```
1. テクスチャサイズ検査
   ↓
2. 1024×1024超過判定
   ├─ YES：リサイズ処理へ進む
   └─ NO：そのまま使用
   ↓
3. リサイズ処理（image クレート利用）
   - 対象：1024×1024を上限に縮小
   - 方法：バイリニア補間（デフォルト）/ ニアレスト / バイキュービック / Gaussian / Lanczos3
   ↓
4. PNG再圧縮（oxipng利用）
   - 最適化レベル：--opt 4（デフォルト）
   - 容量削減効果：入力サイズにより20-50%削減期待
   ↓
5. glTFバッファに統合
```

**テクスチャ圧縮オプション**

- **自動縮小 ON（推奨）**
  - 1024×1024超過時に自動リサイズ
  - oxipngで再圧縮（ロスレス）
  - Second Lifeアップロード費用削減
  - リサイズ品質低下を最小化

- **自動縮小 OFF**
  - オリジナルテクスチャを保持
  - Second Lifeアップロード費用が増加
  - 高品質テクスチャ維持（選択肢あり）

**費用シミュレーション表示**

バリデーションパネルに以下を表示：

```
テクスチャ統計：
- 総テクスチャ数：5枚
- 1024×1024超過：2枚（2048×2048）
- 推定アップロード費用：500L$（圧縮前）→ 200L$（圧縮後）
- 費用削減：60%
```

---

## 📦 最終成果物

### CLIツール

```bash
vrm2sl input.vrm output.gdb
```

### 出力ファイル形式

- **形式：** glTF 2.0 JSON
- **パッケージ：** Second Lifeアップロード可能（.gdbファイル）

---

## ✅ 検証と成功条件

### ❌ 対応しないもの

- 表情・ブレンドシェイプ
- 物理ボーン
- 揺れ物
- 胸揺れ・尻揺れ（Second Lifeシェイプ依存のため）
- Fitted Mesh
- モーション・アニメーション（出力は対応しない）
- シェイプ連動

### 🎯 成功条件

- SL内で基本アニメーションが破綻しない
- 腕のねじれがない
- 足が崩れない
- 全身動作が正常

### 🧪 検証手順

1. 変換後glTFをBlenderへ再読み込み
2. Tポーズ確認
3. アーマチュア崩壊がないか確認
4. SLへアップロード
5. アルファで元ボディを消去して動作確認

---

## ⚠️ 既知の制限事項と対応方法

### 瞳テクスチャの描画問題

**問題**

VRoidモデルの瞳は半透明テクスチャ（アルファチャンネル含む）として組み込まれています。

- **three.js（プレビュー）：** 半透明テクスチャは正常に描画可能
- **Second Life エンジン：** 半透明テクスチャの描画がサポートされていないか、正常に描画されない可能性がある

**現在の対応**

v0.1ではこの問題への自動変換は実装しません。以下の手動対応を推奨：

1. **Blenderでの焼き込み（推奨）**
   - 変換後のglTFをBlenderで開く
   - 瞳メッシュのアルファチャンネル付きテクスチャを、不透明テクスチャベイクで焼き替え
   - テクスチャを再エクスポート

2. **SL内での対応**
   - 瞳部分を別メッシュとして認識
   - SL内で瞳形状に合わせたプリムを配置
   - または、フルボディアルファマスクで瞳のアルファを調整

**将来対応（v1.2以降）**

- テクスチャ自動焼き込み機能の実装
- 瞳プリセット形状の自動生成

### テクスチャサイズとメモリ制限

**Second Lifeの制限**

- テクスチャメモリ上限：一般的に1536×1536ピクセル以下推奨
- アップロード費用：テクスチャサイズに応じて変動
  - 1024×1024以下：低価格帯
  - 1024×1024超過：費用増加（2048×2048等で2-3倍）

**このツールでの対応**

**v0.1：自動テクスチャ縮小機能（デフォルト：ON）**

エクスポート時に「📦 テクスチャ圧縮・自動縮小」オプションが利用可能：

1. **自動縮小 ON（推奨）**
   - 1024×1024超過テクスチャを自動リサイズ
   - oxipngで再圧縮（ロスレス）
   - Second Lifeアップロード費用を削減
   - バリデーションで費用削減目安を表示

2. **自動縮小 OFF**
   - オリジナルテクスチャを保持
   - 高品質を維持するが、アップロード費用が増加
   - テクスチャサイズ警告が表示される

---

## 🔥 期待される難易度

- **実装時間：** 3〜7日
- **デバッグ：** SLアップロードで調整必須
- **必須知識：** 行列演算、ボーン操作、glTF仕様理解
